name: DingTalk Custom Notify

on:
  issues:
    types: [ opened ]

jobs:
  dingtalk:
    runs-on: ubuntu-latest
    steps:
      - name: Notify
        uses: actions/github-script@v7
        env:
          DING_WEBHOOK: ${{ secrets.DINGTALK_WEBHOOK }}
          DING_SECRET: ${{ secrets.DINGTALK_SECRET }}
        with:
          script: |
            const crypto = require('crypto');
            
            const secret = process.env.DING_SECRET;
            const timestamp = Date.now();
            const stringToSign = timestamp + "\n" + secret;
            const sign = crypto.createHmac('sha256', secret).update(stringToSign).digest('base64');
            const url = `${process.env.DING_WEBHOOK}&timestamp=${timestamp}&sign=${encodeURIComponent(sign)}`;

            const issue = context.payload.issue;
            const data = {
              msgtype: "markdown",
              markdown: {
                title: "æ–° Issue é€šçŸ¥",
                text: `### ğŸ”” æ–° Issue æé†’\n` +
                      `> **æ ‡é¢˜**: ${issue.title}\n\n` +
                      `> **ä½œè€…**: ${issue.user.login}\n\n` +
                      `> **è¯¦æƒ…**: [ç‚¹å‡»æŸ¥çœ‹ Issue](${issue.html_url})`
              },
              at: {
                isAtAll: false
              }
            };

            const res = await fetch(url, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(data)
            });

            if (!res.ok) {
              console.log(await res.text());
              throw new Error('é’‰é’‰å‘é€å¤±è´¥');
            }