name: PR Quality & Security Checker

on:
  pull_request:
    types: [ opened, edited, synchronize ]

jobs:
  check-pr:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read # è¯»å–æ–‡ä»¶åˆ—è¡¨éœ€è¦æ­¤æƒé™

    steps:
      - name: Validate PR Content and Files
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const { owner, repo } = context.repo;
            
            // åŒ…å«ç›®å½•å‰ç¼€æˆ–å®Œæ•´æ–‡ä»¶å
            const restrictedPaths = ['.github/', 'CHANGELOG.md'];

            const { data: files } = await github.rest.pulls.listFiles({
              owner,
              repo,
              pull_number: pr.number,
            });

            const modifiedRestrictedFiles = files
              .map(f => f.filename)
              .filter(path => restrictedPaths.some(p => path.startsWith(p)));

            if (modifiedRestrictedFiles.length > 0) {
              console.log(`Restricted files modified: ${modifiedRestrictedFiles.join(', ')}`);
            
              const rejectMessage = `
              âŒ **PR å·²è‡ªåŠ¨å…³é—­**
            
              ä½ å¥½ @${pr.user.login}ï¼Œæ£€æµ‹åˆ°æ­¤ PR ä¿®æ”¹äº†å—ä¿æŠ¤çš„æ–‡ä»¶æˆ–ç›®å½•ï¼š
              \`${modifiedRestrictedFiles.join(', ')}\`
            
              **è¯´æ˜ï¼š**
              ä¸ºäº†ç¡®ä¿é¡¹ç›®å®‰å…¨å’Œæµç¨‹ç»Ÿä¸€ï¼Œ\`${restrictedPaths.join(' å’Œ ')}\` ä¸‹çš„å†…å®¹ä»…é™å†…éƒ¨ç»´æŠ¤è€…ä¿®æ”¹ï¼Œä¸æ¥å—ç¤¾åŒºè´¡çŒ®ã€‚
            
              å¦‚æœä½ è®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªå¿…è¦çš„æ”¹åŠ¨ï¼Œè¯·å…ˆåœ¨ Issue ä¸­ä¸ç»´æŠ¤è€…æ²Ÿé€šã€‚è°¢è°¢é…åˆï¼
              `;

              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: pr.number,
                body: rejectMessage
              });

              await github.rest.pulls.update({
                owner,
                repo,
                pull_number: pr.number,
                state: 'closed'
              });
            
              return; // ç›´æ¥é€€å‡ºï¼Œä¸å†è¿›è¡Œåç»­æ ¡éªŒ
            }

            let errors = [];
            const body = pr.body || "";
            
            if (body.length < 30) {
              errors.push("ğŸ“ **æè¿°è¿‡çŸ­**ï¼šè¯·è¯¦ç»†è¯´æ˜ä¿®æ”¹å†…å®¹ï¼ˆè‡³å°‘ 30 ä¸ªå­—ç¬¦ï¼‰ã€‚");
            }

            if (errors.length > 0) {
              const commentBody = `
              ğŸ‘‹ @${pr.user.login}ï¼Œæ„Ÿè°¢æäº¤ï¼åœ¨åˆå¹¶å‰è¯·ååŠ©å®Œå–„ï¼š
            
              ${errors.map(err => `- ${err}`).join('\n')}
              `;

              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: pr.number,
                body: commentBody
              });
            }