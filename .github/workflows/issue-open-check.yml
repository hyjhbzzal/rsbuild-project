name: Issue Quality Checker

on:
  issues:
    types: [ opened ] # 当 issue 被创建时触发

jobs:
  issue-open-check:
    runs-on: ubuntu-latest
    permissions:
      issues: write # 需要写入权限来关闭 issue 和评论

    steps:
      - name: Check Issue Body
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body;
            const title = issue.title.toLowerCase(); // 转小写以便不区分大小写
            const isTooShort = !body || body.length < 20;
            
            const webKeywords = ['官网', '网站', ,'国内', '镜像'];
            const actionKeywords = ['挂了','挂掉了','无法访问','不能访问','访问速度','访问慢','访问不了','加载太慢','加载慢','加载很慢','出问题','打不开','登不上'];
            const hasForbiddenKeyword = webKeywords.some(keyword => title.includes(keyword))&&actionKeywords.some(keyword => title.includes(keyword));
            
            async function closeIssue(reasonComment) {
              console.log("Closing issue...");
            
              try {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  labels: ['invalid'] 
                });
              } catch (e) { console.log("Label error (ignore if label missing)"); }

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: reasonComment
              });

              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed'
              });
            }
            
            if (hasForbiddenKeyword) {
              const reply = `
              你好 @${issue.user.login}，
            
              检测到你的 Issue 标题包含 **不支持的关键词** (如：官网、网站状态、IE 浏览器等)，因此已被自动关闭。
            
              **说明：**
              1. **官网/网站问题**：GitHub Issues 仅用于代码库的 Bug 反馈，官网服务状态请联系客服或查看状态页。
              2. **IE 兼容性**：本项目已不再支持 Internet Explorer (IE) 浏览器，请升级 Edge 或使用 Chrome/Firefox。
            
              如果是误判，请修改标题并重新开启 Issue。
              `;
              await closeIssue(reply);
              return;
            }
            
            if (isTooShort) {
              try {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  labels: ['invalid']
                });
              } catch (e) {
                console.log("Could not add label, maybe it doesn't exist yet?");
              }

              const commentBody = `
              你好 @${issue.user.login}，
            
              检测到你的 Issue **不符合规范**，因此已被自动关闭。
            
              **可能的原因：**
              1. 描述过于简单或字数太少。
            
              请修改你的 Issue 描述，补充详细的复现步骤、环境信息或日志。修改并符合规范后，你可以重新开启此 Issue (Reopen)。
            
              > 这是一个自动回复，如有误判请谅解。
              `;

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: commentBody
              });

              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed'
              });
            }