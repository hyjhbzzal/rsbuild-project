name: Auto Close Issues

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch: # 允许手动触发测试

jobs:
  cleanup-help-wanted:
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - name: Close Expired Help Wanted Issues
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'help wanted'
            });

            const now = new Date();
            const TEN_MINUTES_MS = 10 * 60 * 1000;

            for (const issue of issues) {
              const { data: events } = await github.rest.issues.listEvents({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
              });

              const lastLabeledEvent = events
                .filter(e => e.event === 'labeled' && e.label.name === 'help wanted')
                .pop();

              if (lastLabeledEvent) {
                const labeledAt = new Date(lastLabeledEvent.created_at);
                const duration = now - labeledAt;

                // 3. 判断是否超过 10 分钟
                if (duration > TEN_MINUTES_MS) {

                  // 发表评论
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.number,
                    body: `⚠️ 该 Issue 被标记为 "help wanted" 已超过 10 分钟且未被处理，现由系统自动关闭。如需继续跟进，请确保移除相关标签或重新提交。`
                  });

                  // 关闭 Issue
                  await github.rest.issues.update({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.number,
                    state: 'closed'
                  });
                }
              }
            }